<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CryptoVerse Dashboard</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background: #0f172a; }
    /* animaÃ§Ã£o moeda flutuante */
    @keyframes floating { 0%{ transform: translateY(0) } 50%{ transform: translateY(-15px) } 100%{ transform: translateY(0) } }
    .animate-floating { animation: floating linear infinite; }
    .card { background: #1e293b; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .table thead { background: #334155; }
    .table tbody tr { border-top: 1px solid #475569; }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen text-white relative">
  <!-- moedas flutuantes -->
  <div id="bg-coins" class="absolute inset-0 z-0 opacity-70 pointer-events-none overflow-hidden"></div>

  <main class="max-w-6xl mx-auto relative z-10 py-16 px-4 md:py-24">
    <h1 class="text-3xl font-bold mb-10 text-center">CryptoVerse Performance</h1>

    <div id="loading" class="text-center text-slate-300">Carregando...</div>

    <section id="content" class="hidden">
      <!-- Cards Topo -->
      <div class="grid md:grid-cols-5 gap-6 text-center mb-16">
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Total Trades</h2>
          <p id="totalTrades" class="text-2xl font-bold">0</p>
        </div>
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Lucro Total</h2>
          <p id="lucroTotal" class="text-2xl font-bold">0%</p>
        </div>
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Maior Lucro</h2>
          <p id="lucroMax" class="text-2xl text-green-300 font-bold">0%</p>
        </div>
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Maior PrejuÃ­zo</h2>
          <p id="prejuizoMax" class="text-2xl text-red-400 font-bold">0%</p>
        </div>
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Taxa de Acerto</h2>
          <p id="taxaAcerto" class="text-2xl text-yellow-400 font-bold">0%</p>
        </div>
      </div>

      <!-- Cards 2Âª linha -->
      <div class="grid md:grid-cols-4 gap-6 text-center mb-16">
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Trades Positivos</h2>
          <p id="tradesPositivos" class="text-2xl text-green-400 font-bold">0 (0%)</p>
        </div>
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Trades Negativos</h2>
          <p id="tradesNegativos" class="text-2xl text-red-400 font-bold">0 (0%)</p>
        </div>
        <div class="card p-6 rounded-xl">
          <h2 class="text-xl font-bold">Tempo MÃ©dio de Trade</h2>
          <p id="tempoMedioTrade" class="text-2xl text-blue-300 font-bold">--</p>
        </div>
        <div class="card p-6 rounded-xl flex flex-col justify-center">
          <h2 class="text-xl font-bold mb-2">Ãšltimo Sinal Aberto</h2>
          <p id="ultimoSinalAberto" class="text-2xl text-blue-300 font-bold">â€”</p>
        </div>
      </div>

      <!-- Simulador -->
      <!-- <h2 class="text-2xl font-bold mb-4">Simulador de Rendimento baseado nos sinais enviados</h2>
      <div class="card rounded-xl p-6 mb-8 space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block mb-1 font-semibold">Valor investido por Sinal ($)</label>
            <input id="valorInvestido" type="number" min="1" value="100" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white" />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Alavancagem</label>
            <select id="alavancagem" class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white">
              <option>1</option><option>2</option><option>5</option><option>10</option><option>15</option><option selected>20</option><option>50</option><option>100</option>
            </select>
          </div>
        </div>
        <div class="mt-2">
          <p class="text-lg font-semibold">ðŸ’° Lucro Total Simulado: <span id="ganhoTotal" class="text-green-400">$0.00</span></p>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="table w-full text-sm bg-slate-800 rounded-lg">
            <thead>
              <tr>
                <th class="p-3 text-left">MÃªs</th>
                <th class="p-3 text-left">Rentabilidade</th>
                <th class="p-3 text-left">Lucro Estimado</th>
              </tr>
            </thead>
            <tbody id="simuladorBody"></tbody>
          </table>
        </div>
      </div> -->

      <!-- GrÃ¡ficos -->
      <h2 class="text-2xl font-bold mb-4">Rentabilidade por MÃªs</h2>
      <div class="card p-4 rounded-xl mb-12">
        <canvas id="chartRentMensal" height="100"></canvas>
      </div>

      <h2 class="text-2xl font-bold mb-4">Rentabilidade Acumulada (%)</h2>
      <div class="card p-4 rounded-xl mb-12">
        <canvas id="chartAcumulado" height="100"></canvas>
      </div>

      <h2 class="text-2xl font-bold mb-4">Quantidade de Sinais por MÃªs</h2>
      <div class="card p-4 rounded-xl mb-12">
        <canvas id="chartQtdMensal" height="100"></canvas>
      </div>

      <!-- <h2 class="text-2xl font-bold mb-4">Rentabilidade Acumulada (%)</h2>
      <div class="card p-4 rounded-xl mb-12">
        <canvas id="chartAcumulado" height="100"></canvas>
      </div> -->

      <!-- Ranking -->
      <!-- <h2 class="text-2xl font-bold mb-4">Ranking de Moedas</h2>
      <div class="overflow-x-auto mb-12">
        <table class="table w-full text-sm bg-slate-800 rounded-lg">
          <thead>
            <tr>
              <th class="p-3 text-left">#</th>
              <th class="p-3 text-left">Moeda</th>
              <th class="p-3 text-left">Rentabilidade Total</th>
              <th class="p-3 text-left">Qtd. de Sinais</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </div> -->
    </section>
  </main>

  <script>
    // === BG coins ===
    (function renderCoins(){
      const el = document.getElementById('bg-coins');
      const coins = [
        'https://iili.io/3ZL900P.md.png',
        'https://iili.io/3ZsyvNj.md.png',
        'https://iili.io/3ZLHswJ.md.png',
      ];
      for(let i=0;i<25;i++){
        const img = document.createElement('img');
        const coin = coins[Math.floor(Math.random()*coins.length)];
        const size = Math.random()*10 + 10;
        const duration = Math.random()*10 + 10;
        const delay = Math.random()*5;
        img.src = coin; img.alt = 'Crypto';
        img.className = 'absolute animate-floating';
        img.style.top = (Math.random()*100)+'%';
        img.style.left = (Math.random()*100)+'%';
        img.style.width = size+'px';
        img.style.height = size+'px';
        img.style.animationDuration = duration+'s';
        img.style.animationDelay = delay+'s';
        el.appendChild(img);
      }
    })();

    // === Supabase ===
    const supabaseUrl = 'https://tnpysphwjohiaqpyedwv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRucHlzcGh3am9oaWFxcHllZHd2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0Njc0Mjk4MSwiZXhwIjoyMDYyMzE4OTgxfQ.nNMUCothOZH3mXZc7pZoZ-p82Yc2uN4fhiNmuil7Dx0';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // helpers
    const fmt2 = (n)=> (Number(n)||0).toFixed(2);
    const monthKey = (iso)=>{ const d=new Date(iso); const y=d.getFullYear(); const m=(d.getMonth()+1).toString().padStart(2,'0'); return `${y}-${m}`; };

    function tempoHumanoDesde(dateStr){
      try{
        const created = new Date(dateStr + 'Z');
        const now = new Date();
        const diffMin = Math.max(1, Math.floor((now - created) / (1000*60)));
        const d = Math.floor(diffMin/(60*24));
        const h = Math.floor((diffMin%(60*24))/60);
        const m = diffMin%60;
        const parts=[]; if(d>0) parts.push(d+'d'); if(h>0) parts.push(h+'h'); if(m>0||parts.length===0) parts.push(m+'min');
        return parts.join(' ') + ' atrÃ¡s';
      }catch(e){ return 'â€”'; }
    }

    // state
    let closedSignals = [];
    let ultimoSinalAberto = null;

    async function fetchData(){
      const { data: closed, error: err1 } = await supabaseClient
        .from('sinais_trade')
        .select('*')
        .eq('signal_exit', 'CLOSE');

      const { data: aberto, error: err2 } = await supabaseClient
        .from('sinais_trade')
        .select('*')
        .order('created_at', { ascending: false })
        .is('signal_exit', null)
        .limit(1);

      if(err1){ console.error(err1); }
      if(err2){ console.error(err2); }

      closedSignals = closed || [];
      ultimoSinalAberto = (aberto && aberto.length>0) ? aberto[0] : null;
    }

    function computeStats(){
      const resultados = closedSignals.map(s => Number(s.resultado || 0));
      const total = resultados.length;
      const lucroTotal = resultados.reduce((a,v)=>a+v,0);
      const lucroMax = resultados.length ? Math.max(...resultados) : 0;
      const prejuMax = resultados.length ? Math.min(...resultados) : 0;
      const acertos = resultados.filter(v=>v>0).length;
      const taxaAcerto = total>0 ? (acertos/total*100) : 0;

      // mensais
      const mapaMesLucro = {};
      const mapaMesQtd = {};
      for(const s of closedSignals){
        const k = monthKey(s.created_at);
        const r = Number(s.resultado||0);
        mapaMesLucro[k] = (mapaMesLucro[k]||0) + r;
        mapaMesQtd[k] = (mapaMesQtd[k]||0) + 1;
      }
      const rentabilidadeMensal = Object.entries(mapaMesLucro)
        .map(([mes, lucro])=>({mes, lucro: Number(fmt2(lucro))}))
        .sort((a,b)=> a.mes.localeCompare(b.mes));
      const quantidadeMensal = Object.entries(mapaMesQtd)
        .map(([mes, quantidade])=>({mes, quantidade}))
        .sort((a,b)=> a.mes.localeCompare(b.mes));

      // acumulado
      let acumulado = 0, maxPeak = 0, maxDrawdown = 0;
      const crescimentoMensal = rentabilidadeMensal.map(({mes, lucro})=>{
        acumulado += lucro;
        maxPeak = Math.max(maxPeak, acumulado);
        const dd = acumulado - maxPeak; // negativo
        maxDrawdown = Math.min(maxDrawdown, dd);
        return { mes, acumulado: Number(fmt2(acumulado)), rendimento: Number(fmt2(lucro)) };
      });

      // duraÃ§Ã£o mÃ©dia
      let totalMin = 0, count = 0;
      for(const s of closedSignals){
        if(s.created_at && s.updated_at){
          const created = new Date(s.created_at);
          const updated = new Date(s.updated_at);
          const mins = (updated - created)/(1000*60);
          if(!isNaN(mins)){ totalMin += mins; count++; }
        }
      }
      const media = count>0 ? totalMin/count : 0;
      const dias = Math.floor(media/(60*24));
      const horas = Math.floor((media%(60*24))/60);
      const minutos = Math.round(media%60);
      const tempoMedioTrade = dias>0 ? `${dias}d ${horas}h ${minutos}min` : `${horas}h ${minutos}min`;

      // ranking por moeda
      const mapRank = {};
      for(const {symbol, resultado} of closedSignals){
        if(!symbol) continue;
        const r = parseFloat(resultado||0);
        if(!mapRank[symbol]) mapRank[symbol] = { symbol, rentabilidade: 0, sinais: 0 };
        mapRank[symbol].rentabilidade += r;
        mapRank[symbol].sinais += 1;
      }
      const ranking = Object.values(mapRank).sort((a,b)=> b.rentabilidade - a.rentabilidade);

      return { total, lucroTotal, lucroMax, prejuMax, taxaAcerto, rentabilidadeMensal, quantidadeMensal, crescimentoMensal, tempoMedioTrade, ranking };
    }

    function renderStats(stats){
      document.getElementById('totalTrades').textContent = stats.total;
      const lucroTotalEl = document.getElementById('lucroTotal');
      const lucroTotalPct = fmt2(stats.lucroTotal);
      lucroTotalEl.textContent = `${lucroTotalPct}%`;
      lucroTotalEl.classList.toggle('text-green-400', stats.lucroTotal >= 0);
      lucroTotalEl.classList.toggle('text-red-400', stats.lucroTotal < 0);

      document.getElementById('lucroMax').textContent = fmt2(stats.lucroMax) + '%';
      document.getElementById('prejuizoMax').textContent = fmt2(stats.prejuMax) + '%';
      document.getElementById('taxaAcerto').textContent = fmt2(stats.taxaAcerto) + '%';

      const positivos = closedSignals.filter(s => Number(s.resultado||0) > 0).length;
      const negativos = closedSignals.length - positivos;
      document.getElementById('tradesPositivos').textContent = `${positivos} (${closedSignals.length? (positivos/closedSignals.length*100).toFixed(1):'0.0'}%)`;
      document.getElementById('tradesNegativos').textContent = `${negativos} (${closedSignals.length? (negativos/closedSignals.length*100).toFixed(1):'0.0'}%)`;

      document.getElementById('tempoMedioTrade').textContent = stats.tempoMedioTrade;

      const abertoEl = document.getElementById('ultimoSinalAberto');
      if(ultimoSinalAberto){
        const tempo = tempoHumanoDesde(ultimoSinalAberto.created_at);
        abertoEl.textContent = `${ultimoSinalAberto.symbol} ${tempo}`;
      }else{
        abertoEl.textContent = 'Nenhum sinal aberto encontrado';
        abertoEl.classList.add('text-slate-400','text-sm');
      }
    }

    // Simulador
    function renderSimulador(rentabilidadeMensal){
      const val = Number(document.getElementById('valorInvestido').value || 0);
      const alav = Number(document.getElementById('alavancagem').value || 1);
      const body = document.getElementById('simuladorBody');
      body.innerHTML = '';
      let ganhoTotal = 0;
      for(const {mes, lucro} of rentabilidadeMensal){
        const ganho = val * alav * (Number(lucro)/100);
        ganhoTotal += ganho;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-3 font-semibold">${mes}</td>
          <td class="p-3">${fmt2(lucro)}%</td>
          <td class="p-3 text-green-400 font-bold">$${fmt2(ganho)}</td>
        `;
        body.appendChild(tr);
      }
      document.getElementById('ganhoTotal').textContent = `$${fmt2(ganhoTotal)}`;
    }

    // Ranking
    function renderRanking(ranking){
      const body = document.getElementById('rankingBody');
      body.innerHTML = '';
      ranking.forEach((item, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-3 font-semibold">${idx+1}</td>
          <td class="p-3">${item.symbol}</td>
          <td class="p-3 font-bold ${item.rentabilidade>=0? 'text-green-400':'text-red-400'}">${fmt2(item.rentabilidade)}%</td>
          <td class="p-3">${item.sinais}</td>
        `;
        body.appendChild(tr);
      })
    }

    // Charts
    let chartRent, chartQtd, chartAcum;
    function renderCharts({rentabilidadeMensal, quantidadeMensal, crescimentoMensal}){
      const labels = rentabilidadeMensal.map(r=>r.mes);
      const dataRent = rentabilidadeMensal.map(r=>r.lucro);
      const ctx1 = document.getElementById('chartRentMensal');
      chartRent && chartRent.destroy();
      // Rentabilidade por MÃªs
chartRent = new Chart(ctx1, {
  type: 'bar',
  data: {
    labels,
    datasets: [{
      label: 'Lucro (%)',
      data: dataRent,
      backgroundColor: dataRent.map(v => v >= 0 ? '#22c55e' : '#ef4444') // verde/vermelho
    }]
  },
  options: {
    plugins: {
      legend: { display: false }, // tira a legenda para ficar igual ao exemplo
      tooltip: { callbacks: { label: (ctx)=> `${fmt2(ctx.parsed.y)}%` } },
      datalabels: {
        color: '#fff',
        anchor: 'end',
        align: 'end',
        formatter: (value) => `${fmt2(value)}%`
      }
    },
    scales: {
      x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,.1)' } },
      y: { 
        ticks: { color: '#fff' }, 
        grid: { color: 'rgba(255,255,255,.1)' },
        min: -30,      // igual ao grÃ¡fico da imagem
        max: 230,      // limite superior fixo
        suggestedMin: -30,
        suggestedMax: 230
      }
    }
  },
  plugins: [ChartDataLabels]
});

      const labels2 = quantidadeMensal.map(r=>r.mes);
      const dataQtd = quantidadeMensal.map(r=>r.quantidade);
      const ctx2 = document.getElementById('chartQtdMensal');
      chartQtd && chartQtd.destroy();
      chartQtd = new Chart(ctx2, {
  type: 'bar',
  data: { 
    labels: labels2, 
    datasets: [{
      label: 'Sinais',
      data: dataQtd,
      backgroundColor: '#3b82f6'
    }] 
  },
  options: {
    plugins: {
      legend: { display: false },
      datalabels: {
        color: '#fff',
        anchor: 'end',
        align: 'end'
      }
    },
    scales: {
      x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,.1)' } },
      y: { 
        ticks: { color: '#fff' }, 
        grid: { color: 'rgba(255,255,255,.1)' },
        min: 0,
        max: 200 // limite fixo como no exemplo
      }
    }
  },
  plugins: [ChartDataLabels]
});

      const labels3 = crescimentoMensal.map(r=>r.mes);
      const dataAcum = crescimentoMensal.map(r=>r.acumulado);
      const ctx3 = document.getElementById('chartAcumulado');
      chartAcum && chartAcum.destroy();
      chartAcum = new Chart(ctx3, {
  type: 'line',
  data: { 
    labels: labels3, 
    datasets: [{
      label: 'Acumulado (%)',
      data: dataAcum,
      tension: .3,
      borderColor: '#facc15',   // linha amarela
      backgroundColor: '#facc15',
      pointBackgroundColor: '#facc15',
      pointRadius: 5,
      pointHoverRadius: 7
    }] 
  },
  options: {
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: (ctx)=> `${fmt2(ctx.parsed.y)}%` } },
      datalabels: {
        color: '#22c55e',          // cor dos nÃºmeros (verde)
        anchor: 'end',
        align: 'top',
        font: { weight: 'bold' },
        formatter: (value) => `${fmt2(value)}%`
      }
    },
    scales: {
      x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,.1)' } },
      y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,.1)' } }
    }
  },
  plugins: [ChartDataLabels]  // <<=== precisa adicionar aqui
});
    }

    // eventos simulador
    // document.getElementById('valorInvestido').addEventListener('input', ()=> renderSimulador(current.rentabilidadeMensal));
    // document.getElementById('alavancagem').addEventListener('change', ()=> renderSimulador(current.rentabilidadeMensal));

    let current = { rentabilidadeMensal: [], quantidadeMensal: [], crescimentoMensal: [] };

  (async function init(){
    try{
      await fetchData();
      const stats = computeStats();
      current = stats;
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
      renderStats(stats);
      renderCharts(stats);
    }catch(e){
      console.error(e);
      document.getElementById('loading').textContent = 'Erro ao carregar.';
    }
  })();

  // === Realtime Supabase ===
  supabaseClient
    .channel('sinais-realtime')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'sinais_trade' },
      async (payload) => {
        console.log("ðŸ“¡ AlteraÃ§Ã£o detectada:", payload);

        // Recarregar dados e atualizar dashboard
        await fetchData();
        const stats = computeStats();
        current = stats;
        renderStats(stats);
        renderCharts(stats);
        // renderRanking(stats.ranking); // se quiser exibir ranking tambÃ©m
      }
    )
    .subscribe();
</script>
</body>
</html>
